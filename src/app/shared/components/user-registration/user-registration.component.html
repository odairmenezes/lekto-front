<div class="registration-container">
  <div class="registration-header">
    <h1>Cadastro de Usuário</h1>
    <p>Preencha os dados abaixo para criar sua conta no Cad+ ERP Hospitais</p>
  </div>

  <mat-stepper orientation="vertical" class="registration-stepper">
    <!-- Step 1: Dados Pessoais -->
    <mat-step [stepControl]="userForm.get('firstName')!" label="Dados Pessoais">
      <div class="step-content">
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="registration-form">
          
          <!-- Nome Completo -->
          <div class="row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Primeiro Nome</mat-label>
              <input 
                matInput 
                formControlName="firstName" 
                placeholder="João" 
                maxlength="50">
              <mat-error *ngIf="userForm.get('firstName')?.hasError('required')">
                Nome é obrigatório
              </mat-error>
              <mat-error *ngIf="userForm.get('firstName')?.hasError('name')">
                {{ userForm.get('firstName')?.errors?.['name']?.message }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Último Nome</mat-label>
              <input 
                matInput 
                formControlName="lastName" 
                placeholder="Silva" 
                maxlength="50">
              <mat-error *ngIf="userForm.get('lastName')?.hasError('required')">
                Último nome é obrigatório
              </mat-error>
              <mat-error *ngIf="userForm.get('lastName')?.hasError('name')">
                {{ userForm.get('lastName')?.errors?.['name']?.message }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Email e CPF -->
          <div class="row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Email</mat-label>
              <input 
                matInput 
                type="email" 
                formControlName="email" 
                placeholder="usuario@hospital.com.br">
              <mat-icon matSuffix>email</mat-icon>
              <mat-error *ngIf="userForm.get('email')?.hasError('required')">
                Email é obrigatório
              </mat-error>
              <mat-error *ngIf="userForm.get('email')?.hasError('email')">
                {{ userForm.get('email')?.errors?.['email']?.message }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>CPF</mat-label>
              <input 
                matInput 
                formControlName="cpf" 
                placeholder="000.000.000-00"
                (input)="formatCPF($event)"
                maxlength="14">
              <mat-icon matSuffix>person</mat-icon>
              <mat-error *ngIf="userForm.get('cpf')?.hasError('required')">
                CPF é obrigatório
              </mat-error>
              <mat-error *ngIf="userForm.get('cpf')?.hasError('cpf')">
                {{ userForm.get('cpf')?.errors?.['cpf']?.message }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Telefone -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Telefone</mat-label>
            <input 
              matInput 
              formControlName="phone" 
              placeholder="(11) 99999-9999"
              (input)="formatPhone($event)"
              maxlength="15">
            <mat-icon matSuffix>phone</mat-icon>
            <mat-error *ngIf="userForm.get('phone')?.hasError('required')">
              Telefone é obrigatório
            </mat-error>
            <mat-error *ngIf="userForm.get('phone')?.hasError('phone')">
              {{ userForm.get('phone')?.errors?.['phone']?.message }}
            </mat-error>
          </mat-form-field>
        </form>

        <button mat-button matStepperNext color="primary">
          <mat-icon>arrow_forward</mat-icon>
          Próximo: Senha
        </button>
      </div>
    </mat-step>

    <!-- Step 2: Senha -->
    <mat-step [stepControl]="userForm.get('password')!" label="Senha">
      <div class="step-content">
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Senha</mat-label>
          <input 
            matInput 
            [type]="hidePassword ? 'password' : 'text'" 
            formControlName="password" 
            placeholder="MinhaSenh@123">
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="hidePassword = !hidePassword">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-hint>Mínimo 8 caracteres com maiúscula, minúscula, número e símbolo</mat-hint>
          <mat-error *ngIf="userForm.get('password')?.hasError('required')">
            Senha é obrigatória
          </mat-error>
          <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
            Mínimo 6 caracteres
          </mat-error>
          <mat-error *ngIf="userForm.get('password')?.hasError('noUpperCase')">
            Pelo menos 1 letra maiúscula
          </mat-error>
          <mat-error *ngIf="userForm.get('password')?.hasError('noLowerCase')">
            Pelo menos 1 letra minúscula
          </mat-error>
          <mat-error *ngIf="userForm.get('password')?.hasError('noNumbers')">
            Pelo menos 1 número
          </mat-error>
          <mat-error *ngIf="userForm.get('password')?.hasError('noSpecialChar')">
            Pelo menos 1 caractere especial
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirmar Senha</mat-label>
          <input 
            matInput 
            [type]="hideConfirmPassword ? 'password' : 'text'" 
            formControlName="confirmPassword" 
            placeholder="MinhaSenh@123">
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="hideConfirmPassword = !hideConfirmPassword">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('required')">
            Confirmação de senha é obrigatória
          </mat-error>
          <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('passwordMismatch')">
            Senhas não coincidem
          </mat-error>
        </mat-form-field>

        <div class="password-requirements">
          <h4>Requisitos da senha:</h4>
          <ul>
            <li>Mínimo 8 caracteres</li>
            <li>Pelo menos 1 letra maiúscula (A-Z)</li>
:           <li>Pelo menos 1 letra minúscula (a-z)</li>
            <li>Pelo menos 1 número (0-9)</li>
            <li>Pelo menos 1 símbolo (!@#$%^&*)</li>
          </ul>
        </div>

        <button mat-button matStepperPrevious color="secondary">
          <mat-icon>arrow_back</mat-icon>
          Voltar: Dados Pessoais
        </button>

        <button mat-button matStepperNext color="primary">
          <mat-icon>arrow_forward</mat-icon>
          Próximo: Endereços
        </button>
      </div>
    </mat-step>

    <!-- Step 3: Endereços -->
    <mat-step label="Endereços">
      <div class="step-content">
        <div class="addresses-header">
          <h3>Endereços</h3>
          <p>Adicione pelo menos um endereço. Um deles deve ser marcado como principal.</p>
          <button mat-raised-button color="accent" (click)="addAddress()">
            <mat-icon>add_location</mat-icon>
            Adicionar Endereço
          </button>
        </div>

        <div formArrayName="addresses" class="addresses-container">
          <div 
            *ngFor="let addressGroup of addressesFormArray.controls; let i = index" 
            [formGroupName]="i"
            class="address-card">
            
            <div class="address-header">
              <h4>Endereço {{ i + 1 }}</h4>
              <div class="address-actions">
                <mat-checkbox 
                  formControlName="isMain" 
                  (change)="setMainAddress(i)"
                  [disabled]="addressGroup.get('isMain')?.value">
                  Endereço Principal
                </mat-checkbox>
                <button 
                  *ngIf="addressesFormArray.length > 1" 
                  mat-icon-button 
                  color="warn"
                  (click)="removeAddress(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="address-form">
              <!-- Logradouro e Número -->
              <div class="row">
                <mat-form-field appearance="outline" class="three-quarter">
                  <mat-label>Logradouro</mat-label>
                  <input matInput formControlName="street" placeholder="Rua das Flores">
                  <mat-error *ngIf="addressGroup.get('street')?.hasError('required')">
                    Logradouro é obrigatório
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="quarter">
                  <mat-label>Número</mat-label>
                  <input matInput formControlName="number" placeholder="123">
                  <mat-error *ngIf="addressGroup.get('number')?.hasError('required')">
                    Número é obrigatório
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Complemento -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Complemento</mat-label>
                <input matInput formControlName="complement" placeholder="Apartamento, sala, etc.">
              </mat-form-field>

              <!-- Bairro -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Bairro</mat-label>
                <input matInput formControlName="neighborhood" placeholder="Centro">
                <mat-error *ngIf="addressGroup.get('neighborhood')?.hasError('required')">
                  Bairro é obrigatório
                </mat-error>
              </mat-form-field>

              <!-- Cidade, Estado e CEP -->
              <div class="row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Cidade</mat-label>
                  <input matInput formControlName="city" placeholder="São Paulo">
                  <mat-error *ngIf="addressGroup.get('city')?.hasError('required')">
                    Cidade é obrigatória
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="quarter">
                  <mat-label>Estado</mat-label>
                  <mat-select formControlName="state">
                    <mat-option *ngFor="let estado of estadosBrasileiros" [value]="estado">
                      {{ estado }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="addressGroup.get('state')?.hasError('required')">
                    Estado é obrigatório
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="quarter">
                  <mat-label>CEP</mat-label>
                  <input matInput formControlName="zipCode" placeholder="00000-000"
                         (input)="formatZipCode($event)" maxlength="9">
                  <mat-error *ngIf="addressGroup.get('zipCode')?.hasError('required')">
                    CEP é obrigatório
                  </mat-error>
                  <mat-error *ngIf="addressGroup.get('zipCode')?.hasError('zipCode')">
                    {{ addressGroup.get('zipCode')?.errors?.['zipCode']?.message }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- País -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>País</mat-label>
                <input matInput formControlName="country" value="Brasil" readonly>
              </mat-form-field>

              <!-- Mensagem de erro para endereço duplicado -->
              <mat-error *ngIf="addressGroup.hasError('duplicateAddress')">
                {{ addressGroup.errors?.['duplicateAddress']?.message }}
              </mat-error>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious color="secondary">
            <mat-icon>arrow_back</mat-icon>
            Voltar: Senha
          </button>

          <button 
            mat-raised-button 
            type="submit" 
            (click)="onSubmit()"
            [disabled]="userForm.invalid || isLoading"
            color="primary">
            <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
            <mat-icon *ngIf="!isLoading">person_add</mat-icon>
            {{ isLoading ? 'Cadastrando...' : 'Finalizar Cadastro' }}
          </button>
        </div>
      </div>
    </mat-step>
  </mat-stepper>

  <!-- Informações importantes -->
    <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>info</mat-icon>
        Informações Importantes
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ul>
        <li>✅ CPF válido: Verificado pelo algoritmo oficial brasileiro</li>
        <li>✅ Nome: Mínimo 4 caracteres, apenas letras e espaços</li>
        <li>✅ Email válido: Formato de email padrão</li>
        <li>✅ Telefone: Com DDD válido brasileiro</li>
        <li>✅ Senha: Com critérios de segurança obrigatórios</li>
        <li>✅ Endereços: Pelo menos um principal, sem duplicatas</li>
      </ul>
    </mat-card-content>
  </mat-card>
</div>
