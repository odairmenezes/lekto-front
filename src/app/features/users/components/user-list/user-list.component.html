<div class="user-list-container">
  <!-- Menu Inicial Button (for standalone pages) -->
  <div class="menu-inicial-container">
    <button mat-raised-button color="primary" 
            class="menu-inicial-btn-standalone"
            (click)="navigateToHome()">
      <mat-icon>home</mat-icon>
      Menu Inicial
    </button>
  </div>
  
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Usuários</h1>
      <p class="page-subtitle">Gerencie os usuários do sistema</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button color="accent" (click)="toggleSelectMode()" 
              [class.active-select-mode]="isSelectMode"
              matTooltip="Modo de seleção múltipla">
        <mat-icon>{{ isSelectMode ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
        Selecionar
      </button>
      <button mat-stroked-button 
              color="warn" 
              (click)="testBackendHealth()"
              matTooltip="Testar saúde do backend">
        <mat-icon>health_and_safety</mat-icon>
        Health Check
      </button>
      <button mat-stroked-button 
              color="accent" 
              (click)="testUserEndpoint()"
              matTooltip="Testar endpoint de usuários">
        <mat-icon>bug_report</mat-icon>
        Testar API
      </button>
      <button mat-stroked-button 
              color="warning" 
              (click)="forceUserSync()"
              matTooltip="Sincronizar dados do usuário atual (emergência)">
        <mat-icon>sync_problem</mat-icon>
        Sync Usuário
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="openUserForm()"
              [disabled]="isLoading"
              matTooltip="Criar novo usuário">
        <mat-icon>add</mat-icon>
        <span *ngIf="!isLoading">Novo Usuário</span>
        <span *ngIf="isLoading">Carregando...</span>
      </button>
    </div>
  </div>


  <!-- Filters and Search -->
  <div class="filters-container">
    <div class="search-section">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Pesquisar usuários</mat-label>
        <input matInput 
               [formControl]="searchControl"
               placeholder="Nome, email ou CPF">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <div class="filters-section">

      <button mat-icon-button 
              (click)="clearFilters()"
              matTooltip="Limpar filtros">
        <mat-icon>clear</mat-icon>
      </button>

      <button mat-icon-button 
              (click)="refreshUsers()"
              matTooltip="Atualizar">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar (when users are selected) -->
  <div class="bulk-actions-bar" *ngIf="isSelectMode && hasSelection()" @slideDown>
    <div class="bulk-actions-content">
      <div class="selection-info">
          <mat-icon>check_circle</mat-icon>
        {{ getSelectedUsersCount() }} usuário(s) selecionado(s)
      </div>
      
      <div class="bulk-actions">
        <button mat-stroked-button color="primary" (click)="bulkActivateUsers()">
          <mat-icon>check_circle</mat-icon>
          Ativar
        </button>
        <button mat-stroked-button color="warn" (click)="bulkDeactivateUsers()">
          <mat-icon>cancel</mat-icon>
          Desativar
        </button>
        <button mat-raised-button color="warn" (click)="bulkDeleteUsers()">
          <mat-icon>delete</mat-icon>
          Excluir
        </button>
        <button mat-icon-button (click)="clearSelection()" matTooltip="Limpar seleção">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-container">
    <mat-table [dataSource]="dataSource" matSort class="users-table">
      
      <!-- Selection Column (only in select mode) -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <button mat-icon-button (click)="selectAllUsers()" *ngIf="isSelectMode" 
                  matTooltip="Selecionar todos">
            <mat-icon>{{ selectedUsers.size === dataSource.data.length ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
          </button>
        </th>
        <td mat-cell *matCellDef="let user">
          <button mat-icon-button *ngIf="isSelectMode" 
                  (click)="toggleUserSelection(user.id)"
                  [class.selected]="isUserSelected(user.id)">
            <mat-icon>{{ isUserSelected(user.id) ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
          </button>
        </td>
      </ng-container>
      
      <!-- First Name Column -->
      <ng-container matColumnDef="firstName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
        <td mat-cell *matCellDef="let user">
          <div class="user-info">
            <span class="user-name">{{ user.firstName }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Last Name Column -->
      <ng-container matColumnDef="lastName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Sobrenome</th>
        <td mat-cell *matCellDef="let user">
          <span class="user-name">{{ user.lastName }}</span>
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let user">
          <span class="email-text">{{ user.email }}</span>
        </td>
      </ng-container>

      <!-- CPF Column -->
      <ng-container matColumnDef="cpf">
        <th mat-header-cell *matHeaderCellDef>CPF</th>
        <td mat-cell *matCellDef="let user">
          <span class="cpf-text">{{ user.cpf | cpf }}</span>
        </td>
      </ng-container>

      <!-- Phone Column -->
      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef>Telefone</th>
        <td mat-cell *matCellDef="let user">
          <span class="phone-text">{{ user.phone | phone }}</span>
        </td>
      </ng-container>


      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let user">
          <div class="actions-container">
            <button mat-icon-button 
                    (click)="viewUserDetails(user); $event.stopPropagation()"
                    matTooltip="Ver detalhes">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="openUserForm(user); $event.stopPropagation()"
                    matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button 
                    [color]="user.isActive ? 'warn' : 'primary'"
                    (click)="showStatusDialog(user); $event.stopPropagation()"
                    [matTooltip]="user.isActive ? 'Desativar usuário' : 'Ativar usuário'">
              <mat-icon>{{ user.isActive ? 'pause_circle_filled' : 'play_circle_filled' }}</mat-icon>
            </button>
            <button mat-icon-button 
                    color="warn"
                    (click)="deleteUser(user); $event.stopPropagation()"
                    matTooltip="Excluir">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- No Data Row -->
      <ng-container matColumnDef="noData">
        <td mat-cell *matCellDef="let element" colspan="7" class="no-data-cell">
          <div class="no-data-content">
            <mat-icon class="no-data-icon">person_off</mat-icon>
            <p class="no-data-text">Nenhum usuário encontrado</p>
            <button mat-raised-button color="primary" (click)="openUserForm()">
              Criar primeiro usuário
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
      <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();" 
          class="user-row"
          [class.select-mode]="isSelectMode"
          (click)="!isSelectMode && viewUserDetails(row)"></tr>
      
    </mat-table>
  </div>

  <!-- Paginator -->
  <mat-paginator 
    #paginator
    [length]="totalItems"
    [pageSize]="pageSize"
    [pageSizeOptions]="[5, 10, 25, 50, 100]"
    [showFirstLastButtons]="true"
    [hidePageSize]="false"
    (page)="onPageChange($event)">
  </mat-paginator>

  <!-- Status Confirmation Dialog -->
  <div class="status-dialog-overlay" 
       *ngIf="isStatusDialogOpen"
       (click)="cancelStatusChange()">
    <mat-card class="status-dialog" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title class="status-title">
          <mat-icon class="status-icon">{{ userToToggle?.isActive ? 'pause_circle_filled' : 'play_circle_filled' }}</mat-icon>
          {{ userToToggle?.isActive ? 'Desativar Usuário' : 'Ativar Usuário' }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p class="status-message">Tem certeza que deseja {{ userToToggle?.isActive ? 'desativar' : 'ativar' }} este usuário?</p>
        <div class="user-info" *ngIf="userToToggle">
          <p><strong>Nome:</strong> {{ userToToggle.firstName }} {{ userToToggle.lastName }}</p>
          <p><strong>Email:</strong> {{ userToToggle.email }}</p>
          <p><strong>CPF:</strong> {{ userToToggle.cpf }}</p>
          <p><strong>Status Atual:</strong> 
            <span [class]="userToToggle.isActive ? 'status-active' : 'status-inactive'">
              {{ userToToggle.isActive ? 'Ativo' : 'Inativo' }}
            </span>
          </p>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="cancelStatusChange()">Cancelar</button>
        <button mat-raised-button 
                [color]="userToToggle?.isActive ? 'warn' : 'primary'"
                (click)="confirmStatusChange()">
          <mat-icon>{{ userToToggle?.isActive ? 'pause_circle_filled' : 'play_circle_filled' }}</mat-icon>
          {{ userToToggle?.isActive ? 'Desativar' : 'Ativar' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Delete Confirmation Dialog -->
  <div class="delete-dialog-overlay" 
       *ngIf="isDeleteDialogOpen"
       (click)="cancelDelete()">
    <mat-card class="delete-dialog" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>Confirmar Exclusão</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>Tem certeza que deseja excluir <strong>{{ userToDelete?.firstName }} {{ userToDelete?.lastName }}</strong>?</p>
        <p class="delete-warning">Esta ação não pode ser desfeita. Todos os dados do usuário serão removidos permanentemente.</p>
        <div class="user-info" *ngIf="userToDelete">
          <p><strong>Email:</strong> {{ userToDelete.email }}</p>
          <p><strong>CPF:</strong> {{ userToDelete.cpf }}</p>
          <p><strong>Status:</strong> {{ userToDelete.isActive ? 'Ativo' : 'Inativo' }}</p>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="cancelDelete()">Cancelar</button>
        <button mat-raised-button 
                color="warn"
                (click)="confirmDelete()">
          Excluir
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

</div>
