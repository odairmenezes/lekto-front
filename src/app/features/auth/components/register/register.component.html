<div class="register-container">
  <mat-card class="register-card">
    <mat-card-header>
      <mat-card-title>
        <h1 class="register-title">Cad+ ERP</h1>
        <p class="register-subtitle">Crie sua conta</p>
      </mat-card-title>
    </mat-card-header>

    <!-- Progress Stepper -->
    <mat-stepper #stepper class="register-stepper">
      
      <!-- Step 1: Informações Pessoais -->
      <mat-step label="Dados Pessoais" [completed]="currentStep > 1">
        <form [formGroup]="registerForm">
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Nome</mat-label>
              <input matInput 
                     formControlName="firstName"
                     placeholder="Digite seu nome"
                     maxlength="50">
              <mat-error *ngIf="registerForm.get('firstName')?.invalid && registerForm.get('firstName')?.touched">
                {{ getFieldErrorMessage('firstName') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Sobrenome</mat-label>
              <input matInput 
                     formControlName="lastName"
                     placeholder="Digite seu sobrenome"
                     maxlength="50">
              <mat-error *ngIf="registerForm.get('lastName')?.invalid && registerForm.get('lastName')?.touched">
                {{ getFieldErrorMessage('lastName') }}
              </mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>CPF</mat-label>
            <input matInput 
                   formControlName="cpf"
                   placeholder="000.000.000-00"
                   maxlength="14"
                   mask="000.000.000-00">
            <mat-error *ngIf="registerForm.get('cpf')?.invalid && registerForm.get('cpf')?.touched">
              {{ getFieldErrorMessage('cpf') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput 
                   type="email"
                   formControlName="email"
                   placeholder="Digite seu email">
            <mat-icon matSuffix 
                      *ngIf="registerForm.get('email')?.valid && registerForm.get('email')?.touched && registerForm.get('email')?.value"
                      color="primary">check_circle</mat-icon>
            <mat-error *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
              {{ getFieldErrorMessage('email') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Telefone</mat-label>
            <input matInput 
                   formControlName="phone"
                   placeholder="(11) 99999-9999"
                   maxlength="15"
                   mask="(00) 00000-0000">
            <mat-icon matSuffix 
                      *ngIf="registerForm.get('phone')?.valid && registerForm.get('phone')?.touched && registerForm.get('phone')?.value"
                      color="primary">check_circle</mat-icon>
            <mat-error *ngIf="registerForm.get('phone')?.invalid && registerForm.get('phone')?.touched">
              {{ getFieldErrorMessage('phone') }}
            </mat-error>
          </mat-form-field>

        </form>

        <div class="step-actions">
          <button mat-raised-button color="primary" (click)="nextStep()">
            Próximo
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </mat-step>

      <!-- Step 2: Senha -->
      <mat-step label="Senha" [completed]="currentStep > 2">
        <form [formGroup]="registerForm">
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Senha</mat-label>
            <input matInput 
                   [type]="hidePassword ? 'password' : 'text'"
                   formControlName="password"
                   placeholder="Digite sua senha">
            <button matSuffix 
                    mat-icon-button 
                    type="button"
                    (click)="hidePassword = !hidePassword">
              <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-icon matSuffix 
                      *ngIf="registerForm.get('password')?.valid && registerForm.get('password')?.touched && registerForm.get('password')?.value"
                      color="primary">check_circle</mat-icon>
            <mat-hint>Mínimo 8 caracteres com letras maiúsculas, minúsculas, números e símbolos</mat-hint>
            <mat-error *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched">
              {{ getFieldErrorMessage('password') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirmar Senha</mat-label>
            <input matInput 
                   [type]="hideConfirmPassword ? 'password' : 'text'"
                   formControlName="confirmPassword"
                   placeholder="Confirme sua senha">
            <button matSuffix 
                    mat-icon-button 
                    type="button"
                    (click)="hideConfirmPassword = !hideConfirmPassword">
              <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="(registerForm.get('confirmPassword')?.invalid || hasPasswordMismatch()) && registerForm.get('confirmPassword')?.touched">
              Senhas não coincidem
            </mat-error>
          </mat-form-field>

        </form>

        <!-- Password Strength Indicator -->
        <div class="password-strength" *ngIf="registerForm.get('password')?.value">
          <div class="strength-section">
            <mat-progress-bar 
              [value]="getPasswordStrength()"
              mode="determinate"
              color="primary">
            </mat-progress-bar>
            <span class="strength-text">Força da senha: {{ getPasswordStrengthText() }}</span>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            <mat-icon>arrow_back</mat-icon>
            Voltar
          </button>
          <button mat-raised-button color="primary" (click)="nextStep()">
            Próximo
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </mat-step>

      <!-- Step 3: Endereços -->
      <mat-step label="Endereço" [completed]="currentStep > 3">
        <form [formGroup]="registerForm">
          
          <div formArrayName="addresses">
            <div *ngFor="let address of addresses.controls; let i = index" 
                 class="address-form"
                 [formGroupName]="i">
              
              <div class="address-header">
                <h3>{{ address.get('isMain')?.value ? 'Endereço Principal' : `Endereço ${i + 1}` }}</h3>
                <div class="address-actions">
                  <button type="button" 
                          mat-icon-button 
                          *ngIf="!address.get('isMain')?.value"
                          (click)="setMainAddress(i)"
                          matTooltip="Definir como principal">
                    <mat-icon>{{ address.get('isMain')?.value ? 'home' : 'home_outlined' }}</mat-icon>
                  </button>
                  <button type="button" 
                          mat-icon-button 
                          *ngIf="addresses.length > 1"
                          (click)="removeAddress(i)"
                          color="warn"
                          matTooltip="Remover endereço">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="two-thirds-width">
                  <mat-label>Rua</mat-label>
                  <input matInput 
                         formControlName="street"
                         placeholder="Digite a rua">
                  <mat-error *ngIf="address.get('street')?.invalid && address.get('street')?.touched">
                    Rua é obrigatória
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="one-third-width">
                  <mat-label>Número</mat-label>
                  <input matInput 
                         formControlName="number"
                         placeholder="123">
                  <mat-error *ngIf="address.get('number')?.invalid && address.get('number')?.touched">
                    Número é obrigatório
                  </mat-error>
                </mat-form-field>
              </div>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Complemento</mat-label>
                <input matInput 
                       formControlName="complement"
                       placeholder="Apartamento, casa, etc.">
              </mat-form-field>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Bairro</mat-label>
                  <input matInput 
                         formControlName="neighborhood"
                         placeholder="Digite o bairro">
                  <mat-error *ngIf="address.get('neighborhood')?.invalid && address.get('neighborhood')?.touched">
                    Bairro é obrigatório
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Cidade</mat-label>
                  <input matInput 
                         formControlName="city"
                         placeholder="Digite a cidade">
                  <mat-error *ngIf="address.get('city')?.invalid && address.get('city')?.touched">
                    Cidade é obrigatória
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="one-third-width">
                  <mat-label>Estado</mat-label>
                  <mat-select formControlName="state">
                    <mat-option value="SP">São Paulo</mat-option>
                    <mat-option value="RJ">Rio de Janeiro</mat-option>
                    <mat-option value="MG">Minas Gerais</mat-option>
                    <!-- Adicionar todos os estados -->
                  </mat-select>
                  <mat-error *ngIf="address.get('state')?.invalid && address.get('state')?.touched">
                    Estado é obrigatório
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="one-third-width">
                  <mat-label>CEP</mat-label>
                  <input matInput 
                         formControlName="zipCode"
                         placeholder="00000-000"
                         maxlength="9"
                         mask="00000-000">
                  <mat-error *ngIf="address.get('zipCode')?.invalid && address.get('zipCode')?.touched">
                    CEP inválido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="onethird-width">
                  <mat-label>País</mat-label>
                  <input matInput 
                         formControlName="country"
                         value="Brasil"
                         [disabled]="true">
                </mat-form-field>
              </div>
            </div>

            <button type="button" 
                    mat-button 
                    color="primary"
                    (click)="addAddress()"
                    *ngIf="addresses.length < 5">
              <mat-icon>add</mat-icon>
              Adicionar outro endereço
            </button>
          </div>

        </form>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            <mat-icon>arrow_back</mat-icon>
            Voltar
          </button>
          <button mat-raised-button 
                  color="primary" 
                  (click)="onSubmit()"
                  [disabled]="registerForm.invalid || isLoading">
            <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
            <span *ngIf="!isLoading">Criar Conta</span>
          </button>
        </div>
      </mat-step>

    </mat-stepper>

    <!-- Actions -->
    <!-- Seção de ajuda removida - validação com toasts implementada -->

    <mat-card-actions class="register-actions">
      <p>Já tem uma conta?</p>
      <button mat-raised-button color="primary" (click)="navigateToLogin()">
        <mat-icon>login</mat-icon>
        Fazer login
      </button>
    </mat-card-actions>

  </mat-card>
</div>
